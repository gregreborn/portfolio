import nmap

def run_scan(target, port_range):
    """Run a scan on the target using the specified port range."""
    scanner = nmap.PortScanner()
    scanner.scan(target, port_range, arguments="--unprivileged -v")

    print("Raw Scan Result:", scanner._scan_result)  # Debugging
    print("All Hosts:", scanner.all_hosts())  # Debugging

    # Check if any hosts were found
    if not scanner.all_hosts():
        return {"error": f"No hosts or open ports found for {target}"}

    # Parse scan results
    results = {}
    for protocol in scanner[target].all_protocols():
        results[protocol] = []
        ports = scanner[target][protocol].keys()
        for port in sorted(ports):
            state = scanner[target][protocol][port]["state"]
            print(f"Port {port}/{protocol}: {state}")
            results[protocol].append((port, state))
    return results

def detect_common_vulnerabilities(results):
    """Analyze scan results for common vulnerabilities."""
    warnings = []
    for protocol, ports in results.items():
        for port, state in ports:
            if protocol == "tcp" and state == "open":
                if port == 22:
                    warnings.append("Warning: SSH (port 22) is open. Ensure it is secured with strong authentication.")
                if port == 80:
                    warnings.append("Warning: HTTP (port 80) is open. Consider migrating to HTTPS.")
                if port == 443:
                    warnings.append("Info: HTTPS (port 443) is open. Verify SSL certificate validity.")
                if port == 21:
                    warnings.append("Warning: FTP (port 21) is open. Ensure it is properly secured.")
                if port == 3306:
                    warnings.append("Warning: MySQL (port 3306) is open. Restrict access to trusted sources.")
    return warnings
