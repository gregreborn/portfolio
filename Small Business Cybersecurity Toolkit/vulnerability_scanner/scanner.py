import nmap

def run_scan(target, port_range):
    """Run a scan on the target using the specified port range."""
    scanner = nmap.PortScanner()
    scanner.scan(target, port_range, arguments="--unprivileged -v")

    print("Raw Scan Result:", scanner._scan_result)  # Debugging
    print("All Hosts:", scanner.all_hosts())  # Debugging

    # Check if any hosts were found
    if not scanner.all_hosts():
        return {"error": f"No hosts or open ports found for {target}"}

    # Parse scan results
    results = {}
    for protocol in scanner[target].all_protocols():
        results[protocol] = []
        ports = scanner[target][protocol].keys()
        for port in sorted(ports):
            state = scanner[target][protocol][port]["state"]
            print(f"Port {port}/{protocol}: {state}")
            results[protocol].append((port, state))
    return results
